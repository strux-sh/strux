name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version override (leave empty to use package.json)'
        required: false
        type: string

env:
  GO_VERSION: '1.24'
  BUN_VERSION: '1.3.6'

jobs:
  # Extract version from package.json (single source of truth)
  get-version:
    name: Get Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Extract version from package.json
        id: version
        run: |
          # Use workflow input if provided, otherwise read from package.json
          if [ -n "${{ inputs.version }}" ]; then
            VERSION="${{ inputs.version }}"
          else
            VERSION=$(jq -r '.version' package.json)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Release version: $VERSION"

  # Generate runtime types first
  generate-types:
    name: Generate Types
    runs-on: ubuntu-latest
    needs: get-version
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Generate Runtime Types
        run: |
          go run ./cmd/gen-runtime-types -format=ts > src/types/strux-runtime.ts
          cat src/types/strux-runtime.ts

      - name: Upload generated types
        uses: actions/upload-artifact@v4
        with:
          name: generated-types
          path: src/types/strux-runtime.ts

  # Build Go introspection binary for all platforms
  build-go:
    name: Build Go (${{ matrix.os }}-${{ matrix.arch }})
    runs-on: ubuntu-latest
    needs: [get-version, generate-types]
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
            ext: ''
          - os: linux
            arch: arm64
            ext: ''
          - os: darwin
            arch: amd64
            ext: ''
          - os: darwin
            arch: arm64
            ext: ''
          - os: windows
            arch: amd64
            ext: '.exe'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      - name: Build strux-introspect
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          CGO_ENABLED: 0
        run: |
          go build -ldflags="-s -w" -o strux-introspect-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.ext }} ./cmd/strux/main.go

      - name: Upload Go binary
        uses: actions/upload-artifact@v4
        with:
          name: strux-introspect-${{ matrix.os }}-${{ matrix.arch }}
          path: strux-introspect-${{ matrix.os }}-${{ matrix.arch }}${{ matrix.ext }}

  # Build Bun executable for all platforms
  build-bun:
    name: Build Bun CLI (${{ matrix.target }})
    runs-on: ${{ matrix.runner }}
    needs: [get-version, generate-types]
    strategy:
      matrix:
        include:
          - target: linux-x64
            runner: ubuntu-latest
            os: linux
            arch: amd64
          - target: linux-arm64
            runner: ubuntu-latest
            os: linux
            arch: arm64
          - target: darwin-x64
            runner: macos-latest
            os: darwin
            arch: amd64
          - target: darwin-arm64
            runner: macos-latest
            os: darwin
            arch: arm64
          - target: windows-x64
            runner: windows-latest
            os: windows
            arch: amd64
    env:
      STRUX_VERSION: ${{ needs.get-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: ${{ env.BUN_VERSION }}

      - name: Download generated types
        uses: actions/download-artifact@v4
        with:
          name: generated-types
          path: src/types/

      - name: Install dependencies
        run: bun install

      - name: Build executable
        shell: bash
        run: |
          bun build src/index.ts --compile --target=bun-${{ matrix.target }} --outfile strux-${{ matrix.target }} --define:process.env.STRUX_VERSION="\"${STRUX_VERSION}\""

      - name: Upload Bun binary
        uses: actions/upload-artifact@v4
        with:
          name: strux-${{ matrix.target }}
          path: strux-${{ matrix.target }}${{ matrix.os == 'windows' && '.exe' || '' }}

  # Create .deb package for Linux
  build-deb:
    name: Build .deb Package
    runs-on: ubuntu-latest
    needs: [get-version, build-go, build-bun]
    env:
      VERSION: ${{ needs.get-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Linux binaries
        uses: actions/download-artifact@v4
        with:
          pattern: '*linux*'
          path: binaries/
          merge-multiple: true

      - name: Create .deb package structure
        run: |
          mkdir -p deb/DEBIAN
          mkdir -p deb/usr/bin
          mkdir -p deb/usr/share/strux

          # Copy binaries
          cp binaries/strux-linux-x64 deb/usr/bin/strux || cp binaries/strux-linux-amd64 deb/usr/bin/strux
          cp binaries/strux-introspect-linux-amd64 deb/usr/share/strux/strux-introspect
          chmod +x deb/usr/bin/strux
          chmod +x deb/usr/share/strux/strux-introspect

          # Create control file
          cat > deb/DEBIAN/control << EOF
          Package: strux
          Version: ${VERSION}
          Section: devel
          Priority: optional
          Architecture: amd64
          Maintainer: Strux Dev <dev@strux.dev>
          Description: Strux OS CLI
           A framework for building kiosk-style operating systems.
          EOF

          # Create postinst script
          cat > deb/DEBIAN/postinst << 'EOF'
          #!/bin/bash
          ln -sf /usr/share/strux/strux-introspect /usr/bin/strux-introspect
          EOF
          chmod +x deb/DEBIAN/postinst

      - name: Build .deb
        run: |
          dpkg-deb --build deb strux_${VERSION}_amd64.deb

      - name: Upload .deb
        uses: actions/upload-artifact@v4
        with:
          name: strux-deb
          path: strux_*.deb

  # Create .rpm package for Linux
  build-rpm:
    name: Build .rpm Package
    runs-on: ubuntu-latest
    needs: [get-version, build-go, build-bun]
    env:
      VERSION: ${{ needs.get-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Install rpm tools
        run: sudo apt-get update && sudo apt-get install -y rpm

      - name: Download Linux binaries
        uses: actions/download-artifact@v4
        with:
          pattern: '*linux*'
          path: binaries/
          merge-multiple: true

      - name: Create RPM structure
        run: |
          mkdir -p rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          mkdir -p rpmbuild/SOURCES/strux-${VERSION}

          cp binaries/strux-linux-x64 rpmbuild/SOURCES/strux-${VERSION}/strux || \
          cp binaries/strux-linux-amd64 rpmbuild/SOURCES/strux-${VERSION}/strux
          cp binaries/strux-introspect-linux-amd64 rpmbuild/SOURCES/strux-${VERSION}/strux-introspect

          cd rpmbuild/SOURCES && tar -czvf strux-${VERSION}.tar.gz strux-${VERSION}

          cat > ../SPECS/strux.spec << EOF
          Name: strux
          Version: ${VERSION}
          Release: 1
          Summary: Strux OS CLI
          License: MIT
          Source0: strux-%{version}.tar.gz

          %description
          A framework for building kiosk-style operating systems.

          %prep
          %setup -q

          %install
          mkdir -p %{buildroot}/usr/bin
          mkdir -p %{buildroot}/usr/share/strux
          install -m 755 strux %{buildroot}/usr/bin/strux
          install -m 755 strux-introspect %{buildroot}/usr/share/strux/strux-introspect
          ln -sf /usr/share/strux/strux-introspect %{buildroot}/usr/bin/strux-introspect

          %files
          /usr/bin/strux
          /usr/bin/strux-introspect
          /usr/share/strux/strux-introspect
          EOF

      - name: Build RPM
        run: |
          rpmbuild --define "_topdir $(pwd)/rpmbuild" -ba rpmbuild/SPECS/strux.spec

      - name: Upload .rpm
        uses: actions/upload-artifact@v4
        with:
          name: strux-rpm
          path: rpmbuild/RPMS/**/*.rpm

  # Create Windows NSIS installer
  build-nsis:
    name: Build Windows Installer
    runs-on: windows-latest
    needs: [get-version, build-go, build-bun]
    env:
      VERSION: ${{ needs.get-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Windows binaries
        uses: actions/download-artifact@v4
        with:
          pattern: '*windows*'
          path: binaries/
          merge-multiple: true

      - name: Install NSIS
        run: choco install nsis -y

      - name: Install EnVar NSIS plugin
        run: |
          # Download EnVar plugin
          Invoke-WebRequest -Uri "https://nsis.sourceforge.io/mediawiki/images/7/7f/EnVar_plugin.zip" -OutFile "EnVar_plugin.zip"

          # Extract to NSIS plugins directory
          Expand-Archive -Path "EnVar_plugin.zip" -DestinationPath "EnVar_plugin" -Force

          # Copy plugin DLLs to NSIS plugins directories
          Copy-Item "EnVar_plugin\Plugins\x86-ansi\EnVar.dll" "C:\Program Files (x86)\NSIS\Plugins\x86-ansi\" -Force
          Copy-Item "EnVar_plugin\Plugins\x86-unicode\EnVar.dll" "C:\Program Files (x86)\NSIS\Plugins\x86-unicode\" -Force

      - name: Create NSIS script
        shell: bash
        run: |
          cat > installer.nsi << 'EOF'
          !include "MUI2.nsh"

          Name "Strux"
          OutFile "strux-setup.exe"
          InstallDir "$PROGRAMFILES\Strux"
          RequestExecutionLevel admin

          !insertmacro MUI_PAGE_WELCOME
          !insertmacro MUI_PAGE_DIRECTORY
          !insertmacro MUI_PAGE_INSTFILES
          !insertmacro MUI_PAGE_FINISH

          !insertmacro MUI_UNPAGE_CONFIRM
          !insertmacro MUI_UNPAGE_INSTFILES

          !insertmacro MUI_LANGUAGE "English"

          Section "Install"
            SetOutPath "$INSTDIR"
            File "binaries\strux-windows-x64.exe"
            File "binaries\strux-introspect-windows-amd64.exe"

            Rename "$INSTDIR\strux-windows-x64.exe" "$INSTDIR\strux.exe"
            Rename "$INSTDIR\strux-introspect-windows-amd64.exe" "$INSTDIR\strux-introspect.exe"

            ; Add to PATH
            EnVar::AddValue "PATH" "$INSTDIR"

            ; Create uninstaller
            WriteUninstaller "$INSTDIR\uninstall.exe"

            ; Start menu
            CreateDirectory "$SMPROGRAMS\Strux"
            CreateShortcut "$SMPROGRAMS\Strux\Uninstall.lnk" "$INSTDIR\uninstall.exe"
          SectionEnd

          Section "Uninstall"
            Delete "$INSTDIR\strux.exe"
            Delete "$INSTDIR\strux-introspect.exe"
            Delete "$INSTDIR\uninstall.exe"
            RMDir "$INSTDIR"

            Delete "$SMPROGRAMS\Strux\Uninstall.lnk"
            RMDir "$SMPROGRAMS\Strux"

            EnVar::DeleteValue "PATH" "$INSTDIR"
          SectionEnd
          EOF

      - name: Build installer
        run: |
          & "C:\Program Files (x86)\NSIS\makensis.exe" installer.nsi

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: strux-windows-installer
          path: strux-setup.exe

  # Generate Homebrew formula and tarballs
  build-homebrew:
    name: Generate Homebrew Formula
    runs-on: ubuntu-latest
    needs: [get-version, build-go, build-bun]
    env:
      VERSION: ${{ needs.get-version.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Download Darwin binaries
        uses: actions/download-artifact@v4
        with:
          pattern: '*darwin*'
          path: binaries/
          merge-multiple: true

      - name: Create tarballs and get SHAs
        id: tarball
        run: |
          # Create ARM64 tarball
          mkdir -p strux-arm64
          cp binaries/strux-darwin-arm64 strux-arm64/strux || true
          cp binaries/strux-introspect-darwin-arm64 strux-arm64/strux-introspect || true
          chmod +x strux-arm64/*
          tar -czvf strux-${VERSION}-darwin-arm64.tar.gz -C strux-arm64 .
          SHA256_ARM64=$(sha256sum strux-${VERSION}-darwin-arm64.tar.gz | cut -d' ' -f1)
          echo "sha256_arm64=$SHA256_ARM64" >> $GITHUB_OUTPUT

          # Create x64 tarball
          mkdir -p strux-x64
          cp binaries/strux-darwin-x64 strux-x64/strux || true
          cp binaries/strux-introspect-darwin-amd64 strux-x64/strux-introspect || true
          chmod +x strux-x64/*
          tar -czvf strux-${VERSION}-darwin-x64.tar.gz -C strux-x64 .
          SHA256_X64=$(sha256sum strux-${VERSION}-darwin-x64.tar.gz | cut -d' ' -f1)
          echo "sha256_x64=$SHA256_X64" >> $GITHUB_OUTPUT

      - name: Generate Homebrew formula
        run: |
          cat > strux.rb << EOF
          class Strux < Formula
            desc "A framework for building kiosk-style operating systems"
            homepage "https://github.com/strux-dev/strux"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.arm?
                url "https://github.com/strux-dev/strux/releases/download/v${VERSION}/strux-${VERSION}-darwin-arm64.tar.gz"
                sha256 "${{ steps.tarball.outputs.sha256_arm64 }}"
              else
                url "https://github.com/strux-dev/strux/releases/download/v${VERSION}/strux-${VERSION}-darwin-x64.tar.gz"
                sha256 "${{ steps.tarball.outputs.sha256_x64 }}"
              end
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/strux-dev/strux/releases/download/v${VERSION}/strux-linux-arm64"
              else
                url "https://github.com/strux-dev/strux/releases/download/v${VERSION}/strux-linux-x64"
              end
            end

            def install
              if OS.mac?
                bin.install "strux"
                bin.install "strux-introspect"
              else
                bin.install Dir["strux*"].first => "strux"
              end
            end

            test do
              system "#{bin}/strux", "--version"
            end
          end
          EOF

      - name: Upload Homebrew formula
        uses: actions/upload-artifact@v4
        with:
          name: homebrew-formula
          path: strux.rb

      - name: Upload Darwin ARM64 tarball
        uses: actions/upload-artifact@v4
        with:
          name: strux-darwin-arm64-tarball
          path: strux-*-darwin-arm64.tar.gz

      - name: Upload Darwin x64 tarball
        uses: actions/upload-artifact@v4
        with:
          name: strux-darwin-x64-tarball
          path: strux-*-darwin-x64.tar.gz

  # Create GitHub Release
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [get-version, build-deb, build-rpm, build-nsis, build-homebrew]
    permissions:
      contents: write
    env:
      VERSION: ${{ needs.get-version.outputs.version }}
      TAG: ${{ needs.get-version.outputs.tag }}
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          merge-multiple: false

      - name: Prepare release assets
        run: |
          mkdir -p release

          # Copy and rename binaries
          find artifacts -type f -name "strux-*" -exec cp {} release/ \;
          find artifacts -type f -name "*.deb" -exec cp {} release/ \;
          find artifacts -type f -name "*.rpm" -exec cp {} release/ \;
          find artifacts -type f -name "*.exe" -exec cp {} release/ \;
          find artifacts -type f -name "*.tar.gz" -exec cp {} release/ \;
          find artifacts -type f -name "strux.rb" -exec cp {} release/ \;

          ls -la release/

      - name: Prepare release notes
        run: |
          if [ -f CHANGELOG.md ]; then
            # Prefer the section matching the release version, fall back to the first section.
            awk -v version="${VERSION}" '
              BEGIN { in=0 }
              $0 ~ "^##[[:space:]]+v?" version "([[:space:]]|$)" { in=1 }
              $0 ~ /^##[[:space:]]+/ && in==1 && $0 !~ "^##[[:space:]]+v?" version "([[:space:]]|$)" { exit }
              in==1 { print }
            ' CHANGELOG.md > release-notes.md

            if [ ! -s release-notes.md ]; then
              awk '
                BEGIN { in=0 }
                /^##[[:space:]]+/ {
                  if (in==0) { in=1 } else { exit }
                }
                in==1 { print }
              ' CHANGELOG.md > release-notes.md
            fi

            if [ -s release-notes.md ]; then
              cat release-notes.md > release-body.md
              echo "" >> release-body.md
            else
              : > release-body.md
            fi
          else
            : > release-body.md
          fi

          cat >> release-body.md << EOF
          ## Strux ${VERSION}

          ### Installation

          **macOS (Homebrew):**
          \`\`\`bash
          brew tap strux-dev/strux
          brew install strux
          \`\`\`

          **Linux (Debian/Ubuntu):**
          \`\`\`bash
          wget https://github.com/strux-dev/strux/releases/download/${TAG}/strux_${VERSION}_amd64.deb
          sudo dpkg -i strux_${VERSION}_amd64.deb
          \`\`\`

          **Linux (Fedora/RHEL):**
          \`\`\`bash
          wget https://github.com/strux-dev/strux/releases/download/${TAG}/strux-${VERSION}-1.x86_64.rpm
          sudo rpm -i strux-${VERSION}-1.x86_64.rpm
          \`\`\`

          **Windows:**
          Download and run \`strux-setup.exe\`

          ### Binaries

          | Platform | Architecture | File |
          |----------|--------------|------|
          | Linux | x64 | \`strux-linux-x64\` |
          | Linux | arm64 | \`strux-linux-arm64\` |
          | macOS | x64 | \`strux-darwin-x64\` |
          | macOS | arm64 (Apple Silicon) | \`strux-darwin-arm64\` |
          | Windows | x64 | \`strux-windows-x64.exe\` |
          EOF

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          name: Strux ${{ env.VERSION }}
          draft: false
          prerelease: false
          files: release/*
          body_path: release-body.md

  # Publish Homebrew formula to tap repository
  publish-homebrew:
    name: Publish to Homebrew Tap
    runs-on: ubuntu-latest
    needs: [get-version, release]
    env:
      VERSION: ${{ needs.get-version.outputs.version }}
    steps:
      - name: Download Homebrew formula
        uses: actions/download-artifact@v4
        with:
          name: homebrew-formula
          path: .

      - name: Push to Homebrew tap
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          # Clone the tap repository
          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/strux-dev/homebrew-strux.git tap

          # Copy the formula
          cp strux.rb tap/Formula/strux.rb

          # Commit and push
          cd tap
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add Formula/strux.rb
          git commit -m "Update strux to ${VERSION}" || echo "No changes to commit"
          git push
